# 会員登録・ファイル管理システム

## プロジェクト概要
- **名前**: webapp（会員登録・ファイル管理システム）
- **目標**: シンプルな会員登録・ログイン・ファイル管理システム（元々のXサーバー用要件をCloudflare Pagesに現代化）
- **主要機能**: 会員登録、ログイン、画像アップロード（最大5枚）、メッセージ管理、プロフィール編集

## 現在完了している機能

### ✅ 認証システム
- 会員登録（名前、受注番号、メールアドレス、パスワード、メッセージ）
- ログイン・ログアウト機能
- JWT認証とセッション管理
- パスワードのbcryptjs暗号化

### ✅ ファイル管理システム
- 画像アップロード機能（最大5枚、01-05の連番管理）
- **🆕 自動JPG変換**: アップロードされた画像を自動的にJPG形式に変換
  - PNG、WebP、GIF、BMP、TIFF、SVG対応
  - 品質最適化とファイルサイズ圧縮
  - 最大解像度制限（2048x2048）とアスペクト比維持
  - 透明背景を白背景に変換
- Cloudflare R2ストレージ統合
- 画像表示・削除機能
- ファイル形式とサイズバリデーション（10MB制限）

### ✅ ユーザー管理
- プロフィール表示・編集機能
- ユーザーダッシュボード
- 個人データ管理（名前、メッセージ編集）

### ✅ フロントエンドUI
- レスポンシブWebデザイン（TailwindCSS使用）
- ホームページ、登録ページ、ログインページ、ダッシュボード
- 直感的なUIと日本語対応
- Font Awesome アイコン統合

### ✅ 管理者システム
- 管理者専用ダッシュボード
- 全ユーザー情報管理・閲覧機能
- 全画像・URL管理機能
- システム統計情報表示
- ユーザー詳細情報（画像URL含む）表示

## 機能的エントリーURI

### 🏠 メインページ
- **GET** `/` - ホームページ（登録・ログインへのリンク）

### 🔐 認証API
- **POST** `/api/auth/register` - 会員登録
  - Body: `{name, order_number, email, password, message?}`
- **POST** `/api/auth/login` - ログイン
  - Body: `{email, password}`
- **POST** `/api/auth/logout` - ログアウト

### 👤 ユーザー管理API
- **GET** `/api/users/me` - 現在のユーザー情報取得（認証必須）
- **PUT** `/api/users/me` - ユーザー情報更新（認証必須）
  - Body: `{name?, message?}`

### 🖼️ 画像管理API
- **GET** `/api/images/my-images` - ユーザーの画像一覧（認証必須）
- **POST** `/api/images/upload` - 画像アップロード（認証必須）
  - FormData: `image_1`, `image_2`, ..., `image_5`
  - **🆕 自動JPG変換**: 全画像を自動的にJPG形式に変換保存
  - サポート形式: JPEG、PNG、WebP、GIF、BMP、TIFF、SVG
  - 自動品質最適化とファイルサイズ圧縮
- **GET** `/api/images/:emailLocal/:imageNumber(.jpg)` - 画像表示（新形式・認証不要・.jpg拡張子対応）
- **GET** `/api/images/:imageNumber` - 画像表示（旧形式・認証必須）
- **DELETE** `/api/images/:imageNumber` - 画像削除（認証必須）

### 🛡️ 管理者API
- **GET** `/api/admin/users` - 全ユーザー一覧取得（管理者専用）
- **GET** `/api/admin/images` - 全画像一覧取得（管理者専用）
- **GET** `/api/admin/users/:userId` - ユーザー詳細情報（画像含む）（管理者専用）
- **GET** `/api/admin/stats` - システム統計情報（管理者専用）

### 📄 Webページ
- **GET** `/register` - 会員登録ページ
  - **URLパラメーター対応**: `?order_id=ORD123&email=test@example.com&name=田中太郎&message=こんにちは`
  - サポートパラメーター: `order_id`, `order_number`, `id`, `email`, `name`, `customer_name`, `message`
- **GET** `/login` - ログインページ
- **GET** `/dashboard` - ダッシュボード（認証必須）
- **GET** `/admin` - 管理者ダッシュボード（管理者専用）

## URLs
- **開発環境**: https://3000-i3wj386fyitskdom7sb1e-6532622b.e2b.dev
- **GitHub**: （後でプッシュ予定）

## データアーキテクチャ

### データモデル
- **Users**: ユーザー情報（名前、受注番号、メール、パスワード、メッセージ）
- **Images**: 画像メタデータ（連番、ファイル名、パス、サイズ、MIME型）
- **Sessions**: ログインセッション管理

### ストレージサービス
- **Cloudflare D1**: SQLiteベースの分散データベース（ユーザー・画像メタデータ）
- **Cloudflare R2**: S3互換オブジェクトストレージ（画像ファイル本体）
- **JWT + Cookie**: セッション管理

### データフロー
1. ユーザー登録 → D1にユーザー情報保存
2. 画像アップロード → R2にファイル保存 + D1にメタデータ保存
3. 認証 → JWT生成 + D1にセッション保存
4. 画像表示 → D1からメタデータ取得 → R2からファイル配信

## URLパラメーター自動入力機能

### 🔗 対応パラメーター
会員登録ページ（`/register`）では以下のURLパラメーターに対応し、フォームに自動入力されます：

#### 受注番号（必須項目）
- `order_id` - 推奨パラメーター名
- `order_number` - 代替パラメーター名
- `id` - 汎用ID（受注番号として使用）

#### 個人情報（任意）
- `email` - メールアドレス
- `name` - 氏名
- `customer_name` - 顧客名（氏名の代替）
- `message` - メッセージ内容（URLエンコード推奨）

### 📝 URLの例
```
# 基本的な使用例
/register?order_id=ORD001

# 複数パラメーター
/register?order_id=ORD001&email=tanaka@example.com&name=田中太郎

# 日本語メッセージ付き（URLエンコード）
/register?order_id=ORD001&name=田中太郎&message=%E3%81%84%E3%81%A4%E3%82%82%E3%81%82%E3%82%8A%E3%81%8C%E3%81%A8%E3%81%86%E3%81%94%E3%81%96%E3%81%84%E3%81%BE%E3%81%99

# 実際のURL例（開発環境）
https://3000-i3wj386fyitskdom7sb1e-6532622b.e2b.dev/register?order_id=ORD123&email=customer@example.com&name=山田花子
```

### ✨ 機能の特徴
- **自動入力**: URLパラメーターから対応するフォームフィールドに自動入力
- **視覚的フィードバック**: 自動入力されたフィールドは一時的に緑色でハイライト
- **通知表示**: パラメーター入力時に自動入力通知を表示
- **日本語対応**: URLエンコードされた日本語パラメーターに対応
- **柔軟性**: 複数の代替パラメーター名に対応

### 🎯 使用シーン
- **ECサイト連携**: 購入完了後の会員登録誘導
- **メール配信**: メルマガからの直接登録リンク
- **営業ツール**: 顧客管理システムからの登録リンク生成
- **アフィリエイト**: 紹介者情報付きの登録リンク

## ユーザーガイド

### 新規登録
1. トップページから「新規会員登録」をクリック
2. 必要情報を入力（名前、受注番号、メールアドレス、パスワード）
3. オプション：メッセージと画像（最大5枚）をアップロード
4. 登録完了後、自動的にダッシュボードにリダイレクト

### ログイン
1. トップページから「ログイン」をクリック
2. メールアドレスとパスワードを入力
3. ログイン成功後、ダッシュボードにリダイレクト

### ダッシュボード使用方法
- **プロフィール確認**: 左側パネルで基本情報確認
- **プロフィール編集**: 「編集」ボタンで名前・メッセージ変更
- **画像管理**: 右側パネルで画像一覧確認・個別アップロード・削除
- **ログアウト**: 右上の「ログアウト」ボタン

### 管理者ダッシュボード使用方法
- **統計情報**: 上部パネルでシステム全体の統計確認
- **ユーザー管理タブ**: 全ユーザー情報一覧・詳細確認
- **画像管理タブ**: 全画像・URL一覧表示
- **ユーザー詳細**: ユーザークリックで詳細情報（画像URL含む）表示
- **URL管理**: 新形式 `/api/images/メールローカル部分/画像番号` でURL表示・コピー機能

### テストアカウント

#### 一般ユーザー
- **メール**: tanaka@example.com
- **パスワード**: password123
- **受注番号**: ORD001

#### 管理者アカウント  
- **メール**: admin@webapp.com
- **パスワード**: password123
- **受注番号**: ADMIN001

## デプロイメント
- **プラットフォーム**: Cloudflare Pages + Workers
- **ステータス**: ✅ ローカル開発環境で正常動作中
- **技術スタック**: Hono + TypeScript + TailwindCSS + D1 + R2
- **最終更新**: 2025-09-08

## 画像URL仕様

### 新しいURL形式（推奨）
- **形式**: `/api/images/{メールローカル部分}/{画像番号}.jpg`
- **例**: `/api/images/tanaka/01.jpg`、`/api/images/sato/05.jpg`、`/api/images/admin/03.jpg`
- **特徴**: 
  - 認証不要でアクセス可能
  - メールアドレスの@より前の部分を使用
  - 画像番号は2桁固定（01-05）+ .jpg拡張子
  - 英数字ベースでクリーンなURL
  - SEO・共有に最適
  - .jpg拡張子付きで直接的な画像ファイルアクセス

### 従来のURL形式（管理者用）
- **形式**: `/api/images/{画像番号}?userId={ユーザーID}`
- **例**: `/api/images/1?userId=1`
- **特徴**: 認証必須、管理者用途

## 開発環境セットアップ

```bash
# 依存関係インストール
npm install

# ローカルデータベース初期化
npm run db:migrate:local
npm run db:seed

# 開発サーバー起動
npm run build
npm run dev:d1

# テスト
curl http://localhost:3000
```

## 最新の実装済み機能

### 🆕 画像自動JPG変換システム
- **実装日**: 2025-09-08
- **技術**: Cloudflare Workers標準API（OffscreenCanvas、createImageBitmap）
- **機能詳細**:
  - 画像形式の自動検出と変換可能性チェック
  - PNG、WebP、GIF、BMP、TIFF、SVG → JPG自動変換
  - 透明背景を白背景に自動変換
  - ファイルサイズベースの品質自動最適化
  - 最大解像度制限（2048x2048）でアスペクト比維持
  - 元ファイル名に変換情報付与（例：`image.png (image/png → JPG, 45.2% 圧縮)`）

### 変換処理フロー
1. **アップロード**: ユーザーが任意形式の画像をアップロード
2. **形式チェック**: サポート形式かバリデーション
3. **変換処理**: Web標準APIで高品質JPG変換
4. **最適化**: ファイルサイズに応じた品質調整
5. **保存**: R2ストレージにJPG形式で保存
6. **記録**: データベースに変換結果とメタデータ保存

## 今後の拡張予定
- ユーザープロフィール画像機能
- 画像にタグ・コメント機能  
- メール通知機能
- バックアップ・エクスポート機能

---

**注意**: これは要件定義書に基づいた現代的な実装です。Cloudflare Pagesの制約に合わせて、PHPではなくHono/TypeScriptで実装し、ファイルシステムではなくR2ストレージを使用しています。